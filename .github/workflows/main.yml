name: Android 9 + KasmVNC (Cloudflare Tunnel)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      IMAGE_NAME: android9-kasm-final
      CONTAINER_NAME: android9-kasm
      RAM_MB: 4096
      CPU_CORES: 4
      PORT: 6901

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ§± Build Android + KasmVNC image
        run: |
          cat <<'EOF' > Dockerfile
          FROM kasmweb/core-ubuntu-focal:1.14.0

          USER root
          ENV DEBIAN_FRONTEND=noninteractive
          ENV ANDROID_SDK_ROOT=/opt/android-sdk

          RUN apt-get update && apt-get install -y curl unzip openjdk-11-jdk && \
              mkdir -p $ANDROID_SDK_ROOT && cd $ANDROID_SDK_ROOT && \
              curl -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip && \
              unzip cmdline-tools.zip -d cmdline-tools && rm cmdline-tools.zip && \
              mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest && \
              mv $ANDROID_SDK_ROOT/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/ || true && \
              yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "system-images;android-28;google_apis;x86_64" "emulator" && \
              yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses && \
              echo "no" | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager create avd -n test -k "system-images;android-28;google_apis;x86_64" -d "Nexus S"

          EXPOSE 6901

          CMD bash -c "/usr/bin/start-kasmvnc --skip-cert-check & \
                       sleep 10 && \
                       /opt/android-sdk/emulator/emulator -avd test \
                         -memory ${RAM_MB:-4096} \
                         -cores ${CPU_CORES:-4} \
                         -gpu swiftshader_indirect \
                         -noaudio \
                         -no-boot-anim \
                         -no-snapshot \
                         -netdelay none \
                         -netspeed full"
          EOF

          docker build -t $IMAGE_NAME .

      - name: ğŸš€ Run Android (KasmVNC)
        run: |
          docker run -d \
            --name $CONTAINER_NAME \
            -p $PORT:6901 \
            -e VNC_PW=123456 \
            -e DISPLAY_WIDTH=1280 \
            -e DISPLAY_HEIGHT=720 \
            $IMAGE_NAME

      - name: â³ Wait for emulator startup
        run: |
          echo "Waiting Android emulator boot..."
          sleep 60
          docker logs $CONTAINER_NAME --tail 40

      - name: ğŸŒ©ï¸ Download Cloudflared
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

      - name: ğŸŒ Start Cloudflare Tunnel
        id: tunnel
        run: |
          nohup ./cloudflared tunnel --url http://localhost:${PORT} --no-autoupdate > tunnel.log 2>&1 &
          for i in {1..120}; do
            URL=$(grep -oE 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' tunnel.log | head -1 || true)
            if [ -n "$URL" ]; then
              echo "url=$URL" >> $GITHUB_OUTPUT
              echo "Public URL: $URL"
              break
            fi
            sleep 1
          done
          if [ -z "$URL" ]; then
            echo "Failed to obtain Cloudflare URL"
            exit 1
          fi

      - name: ğŸ“„ Save tunnel URL
        run: |
          echo "${{ steps.tunnel.outputs.url }}" > remote.txt
          cat remote.txt

      - name: ğŸ•“ Keep alive (6h)
        run: sleep 21600

      - name: ğŸ§¾ Logs (debug)
        if: always()
        run: |
          echo "=== docker ps -a ==="; docker ps -a
          echo "=== docker logs (last 100 lines) ==="; docker logs --tail 100 $CONTAINER_NAME || true
          echo "=== tunnel.log ==="; tail -n 40 tunnel.log || true
