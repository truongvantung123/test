name: Android 9 + KasmVNC VPS (Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: android9-kasm-fixed
      CONTAINER_NAME: android-vnc
      RAM_MB: 4096
      CPU_CORES: 4
      PORT: 6901

    steps:
      - name: üß∞ Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üß© Build Android + KasmVNC image (fixed path)
        run: |
          cat <<'EOF' > Dockerfile
          FROM kasmweb/core-ubuntu-focal:1.14.0

          USER root
          ENV DEBIAN_FRONTEND=noninteractive
          ENV ANDROID_SDK_ROOT=/opt/android-sdk

          RUN apt-get update && apt-get install -y curl unzip openjdk-11-jdk && \
              mkdir -p $ANDROID_SDK_ROOT && cd $ANDROID_SDK_ROOT && \
              curl -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip && \
              unzip cmdline-tools.zip -d cmdline-tools && rm cmdline-tools.zip && \
              mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest && \
              mv $ANDROID_SDK_ROOT/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/ || true && \
              yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "system-images;android-28;google_apis;x86_64" "emulator" && \
              yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses && \
              echo "no" | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager create avd -n test -k "system-images;android-28;google_apis;x86_64" -d "Nexus S"

          EXPOSE 6901

          CMD bash -c "/usr/bin/start-kasmvnc --skip-cert-check & \
                       sleep 10 && \
                       /opt/android-sdk/emulator/emulator -avd test \
                         -memory ${RAM_MB:-4096} \
                         -cores ${CPU_CORES:-4} \
                         -gpu swiftshader_indirect \
                         -noaudio \
                         -no-boot-anim \
                         -no-snapshot \
                         -netdelay none \
                         -netspeed full"
          EOF

          docker build -t $IMAGE_NAME .

      - name: üöÄ Run container (KasmVNC + Android)
        run: |
          docker run -d \
            --name $CONTAINER_NAME \
            -p $PORT:6901 \
            -e VNC_PW=123456 \
            -e DISPLAY_WIDTH=1280 \
            -e DISPLAY_HEIGHT=720 \
            $IMAGE_NAME

      - name: ‚è≥ Wait for emulator
        run: |
          echo "Waiting for Android emulator startup..."
          sleep 45
          docker logs $CONTAINER_NAME

      - name: üåê Info
        run: |
          echo "==========================================="
          echo "‚úÖ Android 9 + KasmVNC ƒë√£ kh·ªüi ch·∫°y!"
          echo "Truy c·∫≠p t·∫°i: http://127.0.0.1:6901"
          echo "M·∫≠t kh·∫©u VNC: 123456"
          echo "==========================================="
